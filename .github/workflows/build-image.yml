name: Build e Push da Imagem Bootc

on:
  schedule:
    # Dispara as 03h45 diariamente (hor√°rio de Bras√≠lia)
    - cron: "45 6 * * *"
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.full_image.outputs.tag }}
      base_version: ${{ steps.base_version.outputs.version }}
      timestamp: ${{ steps.timestamp.outputs.date }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Extrair Vers√£o da Imagem Base
        id: base_version
        run: |
          VERSION=$(grep '^FROM' Containerfile | head -n 1 | awk -F: '{print $2}' | awk '{print $1}')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Gerar Timestamp (Hor√°rio de Bras√≠lia)
        id: timestamp
        run: echo "date=$(TZ='America/Sao_Paulo' date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Tag completa da imagem
        id: full_image
        run: echo "tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.base_version.outputs.version }}-latest" >> $GITHUB_OUTPUT

      - name: Extrair metadados
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.base_version.outputs.version }}-${{ steps.timestamp.outputs.date }}
            type=raw,value=${{ steps.base_version.outputs.version }}-latest
            type=ref,event=branch
            type=sha,format=short
            latest

      - name: Build e Push da Imagem (Rebuild Completo)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile
          push: true
          pull: true
          no-cache: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  generate-iso:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Liberar espa√ßo em disco
        run: |
          echo "Espa√ßo antes:"
          df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost /usr/share/swift /usr/local/.ghcup \
            /opt/hostedtoolcache
          sudo docker image prune -af 2>/dev/null || true
          echo "Espa√ßo depois:"
          df -h /

      - name: Login no GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Puxar imagem do registry
        run: |
          sudo podman pull ${{ needs.build-and-push.outputs.image_tag }}

      - name: Gerar ISO com bootc-image-builder
        run: |
          mkdir -p output
          sudo podman run \
            --rm --privileged \
            -v ./config.toml:/config.toml:ro \
            -v ./output:/output \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            quay.io/centos-bootc/bootc-image-builder:latest \
            --type anaconda-iso \
            --rootfs btrfs \
            ${{ needs.build-and-push.outputs.image_tag }}

      - name: Gerar checksum e dividir ISO
        id: split
        run: |
          ISO_PATH="output/bootiso/install.iso"
          ISO_SIZE=$(stat -c%s "$ISO_PATH")
          echo "Tamanho da ISO: $(numfmt --to=iec $ISO_SIZE)"

          # Checksum da ISO original
          sha256sum "$ISO_PATH" > output/SHA256SUMS.txt
          cat output/SHA256SUMS.txt

          # Divide em partes de 1.9GB
          mkdir -p output/parts
          split -b 1900M -d --additional-suffix=.part "$ISO_PATH" output/parts/install.iso.

          # Lista as partes geradas
          PART_COUNT=$(ls output/parts/ | wc -l)
          echo "Partes geradas: $PART_COUNT"
          ls -lh output/parts/
          echo "part_count=$PART_COUNT" >> $GITHUB_OUTPUT

      - name: Criar Release no GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iso-${{ needs.build-and-push.outputs.base_version }}-${{ needs.build-and-push.outputs.timestamp }}
          name: "üñ•Ô∏è ISO Fedora ${{ needs.build-and-push.outputs.base_version }} ‚Äî ${{ needs.build-and-push.outputs.timestamp }}"
          body: |
            ## üìÄ ISO de Instala√ß√£o ‚Äî Fedora Bootc KDE Plasma Minimal

            **Kernel:** CachyOS | **Desktop:** KDE Plasma 6 | **Nvidia:** Integrado

            ### üì• Como baixar e montar a ISO

            Baixe **todas** as partes `.part` e o `SHA256SUMS.txt`, depois:

            ```bash
            # Remontar a ISO
            cat install.iso.*.part > install.iso

            # Verificar integridade
            sha256sum -c SHA256SUMS.txt
            ```

            ### üî• Gravar no pendrive
            ```bash
            sudo dd if=install.iso of=/dev/sdX bs=4M status=progress oflag=sync
            ```

            > ‚ö†Ô∏è Substitua `/dev/sdX` pelo dispositivo correto do pendrive!

            ---
            Imagem container: `${{ needs.build-and-push.outputs.image_tag }}`
          files: |
            output/parts/*
            output/SHA256SUMS.txt
          fail_on_unmatched_files: true
